name: Java CI

on: [push, pull_request]

permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
  build:
    name: Build ${{matrix.java}}
    runs-on: ubuntu-latest
    strategy: 
      fail-fast: false
      matrix: 
        java: [17, 21]
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK ${{matrix.java}}
      uses: actions/setup-java@v4
      with:
        java-version: ${{matrix.java}}
        distribution: temurin

    - name: Cache local Maven repository
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-java-${{matrix.java}}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-java-${{matrix.java}}

    - name: Build with Maven
      run: mvn -B verify --file pom.xml
      if: ${{matrix.java == 21}}
    - name: Test with Maven
      run: mvn -B test -pl '!:redisson-helidon-40' --file pom.xml
      if: ${{matrix.java != 21}}
